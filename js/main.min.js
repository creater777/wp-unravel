var lastScroll = 0
  , loadLastScroll = !1;
$(function () {
  $("#logo a.logo").click(function (t) {
    $("#nav-group .menu-categories").removeAttr("id")
  })
});
$(document).bind("dofirst", function (t, n) {
  $(n).find("a").click(function (t) {
    var n = $(this);
    $("body");
    n.hasClass("save-last-scroll") ? lastScroll = $(window).scrollTop() : n.hasClass("load-last-scroll") && (loadLastScroll = !0)
  }),
    $(n).find(".menu-skeleton").each(function () {
      function t() {
        var t = s.find("option:selected").data("li")
          , n = t.children("ul");
        if (n.length > 0) {
          var a = n.children("li");
          r.empty();
          $("<option />").val(t.children("a").attr("href")).text(o.parent().find('li:first').text()).appendTo(r);
          a.each(function () {
            var t = $(this)
              , n = t.children("a");
            opt = $("<option />").val(n.attr("href")).text($.trim(n.text())).appendTo(r)
            document.location.href.indexOf(n.attr('href')) >= 0 && opt.prop("selected", !0);
          })
        } else
          r.empty(),
            $("<option />").text("-").prop("disabled", !0).appendTo(r);
        r.formSelect(),
          e.find("ul").length > 0 ? l.show() : l.hide()
      }

      var n = $(this)
        , a = n.parent()
        , e = n
        , o = $("<div />").addClass("row").appendTo(a)
        , i = $("<div />").addClass("col").appendTo(o)
        , l = $("<div />").addClass("col").appendTo(o)
        , s = $("<select />").appendTo(i)
        , r = $("<select />").appendTo(l);
      e.children("li").each(function () {
        var t = $(this)
          , n = t.children("a")
          , a = $("<option />").val(n.attr("href")).text($.trim(n.text())).appendTo(s);
        a.data("li", t);
        !t.hasClass("active") && document.location.href.indexOf(n.attr('href')) >= 0 && t.addClass("active");
        t.hasClass("active") && a.prop("selected", !0)
      }),
        s.change(t).formSelect(),
        t(),
        o.find("select").change(function () {
          $.pjaxRedirect($(this).val())
        })
    })
}),
  $(function () {
    var t = $("html")
      , n = $("body")
      , a = $(".dcore-loading")
      , e = ["#body"];
    $("#pjax-wrapper").smoothState({
      cacheLength: 0,
      blacklist: $.pjaxBlacklist,
      alterRequest: function (t) {
        var n = $.pjaxInstance();
        return n.clear(t.url),
          t
      },
      onStart: {
        duration: 600,
        render: function (n) {
          t.addClass("is-exiting"),
            a.fadeIn(),
            n.data("smoothState").restartCSSAnimations(),
            $(".tooltip-element").remove(),
            $("body > .blueimp-gallery").remove(),
            $(".dropdown-button").dropdown("close"),
            $(e.join(",")).find(".dsticky").each(function () {
              Stickyfill.remove(this)
            })
        }
      },
      onReady: {
        duration: 0,
        render: function (t, a) {
          $('#logo').html(a.find('#logo').html());
          $('#nav-main').html(a.find('#nav-main').html());
          $('.grailed').html(a.find('.grailed').html() || '');
          $('#body').css('padding-top', 0);

          var o = $("<div />").html(a);
          o.find("#body-info").each(function () {
            n.attr("id", $(this).attr("data-id")),
              n.attr("class", $(this).attr("data-class"))
          }),
            e.forEach(function (t) {
              $(t).empty().html(o.find(t).html())
            });
          var i = o.find("#header .menu-categories");
          i.length > 0 ? 0 == $("#" + i.attr("id")).length && $("#header .menu-categories").empty().attr({
            id: i.attr("id")
          }).html(i.html()).dofirst() : $("#header .menu-categories").empty().removeAttr("id");
          var l = o.find("#header .menu-list")
            , s = $("#header .menu-list");
          l.length > 0 ? s.empty().attr({
            id: l.attr("id")
          }).html(l.html()).dofirst() : s.empty().removeAttr("id");
          var r = $("#nav li, #nav li a")
            , d = o.find("#nav li, #nav li a");
          r.each(function (t) {
            var n = $(this).attr("class")
              , a = $(d.get(t)).attr("class");
            n != a && $(this).attr("class", a ? a : "")
          }),
            $("#nav > ul > li.has-children").not($("#nav > ul > li.has-children.active").addClass("opened")).removeClass("opened");
          var c = o.find(".dcore-cart-count:first");
          c.length > 0 && $(".dcore-cart-count").attr("class", c.attr("class")).text(c.text());

          $('#menu-list-all a').on('click', function () {
            $("html").trigger("nav-close")
          });
          $('input[type=file]').each(function () {
            var label = $(this).parents('.field__file-wrapper').find('.field__file-fake');
            var labelVal = label.text();
            $(this).on('change', function (e) {
              var countFiles = this.files && this.files.length >= 1 && this.files.length;
              label.text(countFiles ? 'Выбрано файлов: ' + countFiles : labelVal);
            });
          });
          $('#feedback').html(a.find('#feedback').html());
        }
      },
      onAfter: function (o, i) {
        $('#nav-posts').html(i.find('#nav-posts').html()).dofirst();
        loadLastScroll ? ($(window).scrollTop(lastScroll),
          lastScroll = 0,
          loadLastScroll = !1) : $(window).scrollTop(0),
          n.imagesLoaded({
            background: !0
          }, function () {
            t.removeClass("is-exiting"),
              a.fadeOut()
          }),
          $(e.join(",")).dofirst()
      }
    })
  }),
  $(function () {
    var t = $("html")
      , n = 600;
    $("#nav-group").on("touchstart", function (t) {
      t.stopPropagation()
    }).on("touchmove", function (t) {
      t.stopPropagation()
    }).on("touchend", function (t) {
      t.stopPropagation()
    }),
      t.bind("nav-open", function () {
        t.addClass("nav-opening"),
          $("#nav-group").scrollTop(0),
          setTimeout(function () {
            t.addClass("nav-opened")
          }, 1)
      }).bind("nav-close", function () {
        t.removeClass("nav-opened"),
          setTimeout(function () {
            t.removeClass("nav-opening")
          }, n)
      }),
      $("#nav-trigger").click(function (n) {
        n.preventDefault(),
          t.hasClass("nav-opening") ? t.trigger("nav-close") : t.trigger("nav-open")
      }),
      $("#nav a, #nav .nav-closer").click(function () {
        t.trigger("nav-close")
      })
  }),
  $(function () {
    function t() {
      a = $("[data-src]:not(.loaded-)"),
        a.each(function () {
          var t = $(this);
          0 == t.find(".loading").length && $("<div />").addClass("loading").css({
            position: "absolute",
            top: "50%",
            left: "50%"
          }).appendTo(t).spin()
        })
    }

    function n() {
      e && clearTimeout(e),
        e = setTimeout(function () {
          var t = $(window).height()
            , n = $(window).scrollTop();
          a.filter(":not(.loaded-)").each(function () {
            var a = $(this)
              , e = a.offset().top;
            n + t + 3 * t >= e && a.empty().css({
              backgroundImage: "url(" + a.attr("data-src") + ")"
            }).imagesLoaded({
              background: !0
            }, function () {
              a.addClass("loaded-")
            })
          })
        }, 100)
    }

    var a, e = null;
    t(),
      n(),
      $(window).scroll(n),
      $(document).bind("dofirst", function (a, e) {
        t(),
          n()
      })
  }),
  $(function () {
    $("#nav").each(function () {
      var t = $(this)
        , n = t.find("> ul > li.has-children")
        , a = n.children("ul")
        , e = t.find("> ul > li > a");
      n.each(function () {
        var t = $(this)
          , e = $("<button />").appendTo(t);
        t.hasClass("active") && t.addClass("opened"),
          e.click(function (e) {
            var o = t.children("ul");
            t.hasClass("opened") ? (t.removeClass("opened"),
            $("html").hasClass("mobile") && $("#nav-group").css("overflow-y", "hidden"),
              o.slideUp(function () {
                $("html").hasClass("mobile") && $("#nav-group").css("overflow-y", "scroll")
              })) : (n.not(t.addClass("opened")).removeClass("opened"),
            $("html").hasClass("mobile") && $("#nav-group").css("overflow-y", "hidden"),
              a.not(o.slideDown(function () {
                $("html").hasClass("mobile") && $("#nav-group").css("overflow-y", "scroll")
              })).slideUp())
          })
      }),
        e.click(function (t) {
          var a = $(this)
            , e = a.parent()
            , o = e.children("button");
          o.length > 0 && !e.hasClass("opened") && setTimeout(function () {
            o.click()
          }, 600),
            n.filter(".opened").not(e).children("button").each(function () {
              var t = $(this);
              setTimeout(function () {
                t.click()
              }, 600)
            })
        })
    })
  });
